<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AVI转MP4转换器</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.6;
        color: #333;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background-color: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      header {
        background: linear-gradient(to right, #4b6cb7, #182848);
        color: white;
        padding: 30px;
        text-align: center;
      }

      h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
      }

      .subtitle {
        font-size: 1.1rem;
        opacity: 0.9;
      }

      .main-content {
        display: flex;
        flex-wrap: wrap;
        padding: 30px;
        gap: 30px;
      }

      .left-panel,
      .right-panel {
        flex: 1;
        min-width: 300px;
      }

      .panel {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        height: 100%;
      }

      h2 {
        color: #2c3e50;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #4b6cb7;
        font-size: 1.5rem;
      }

      .file-input-container {
        margin-bottom: 25px;
      }

      .file-label {
        display: block;
        background: #4b6cb7;
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
        font-size: 1.1rem;
      }

      .file-label:hover {
        background: #3a5699;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(75, 108, 183, 0.3);
      }

      #fileInput {
        display: none;
      }

      .file-info {
        margin-top: 15px;
        padding: 15px;
        background-color: white;
        border-radius: 8px;
        border-left: 4px solid #4b6cb7;
      }

      .file-info p {
        margin: 5px 0;
      }

      .file-name {
        font-weight: 600;
        color: #2c3e50;
      }

      .file-size {
        color: #7f8c8d;
        font-size: 0.9rem;
      }

      .controls {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .btn {
        padding: 15px 20px;
        border: none;
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }

      .btn-convert {
        background: linear-gradient(to right, #2ecc71, #27ae60);
        color: white;
      }

      .btn-convert:hover:not(:disabled) {
        background: linear-gradient(to right, #27ae60, #219653);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);
      }

      .btn-convert:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .btn-download {
        background: linear-gradient(to right, #3498db, #2980b9);
        color: white;
        text-decoration: none;
        text-align: center;
      }

      .btn-download:hover {
        background: linear-gradient(to right, #2980b9, #1c6ea4);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
      }

      .btn-reset {
        background: #95a5a6;
        color: white;
      }

      .btn-reset:hover {
        background: #7f8c8d;
        transform: translateY(-2px);
      }

      .progress-container {
        margin-top: 25px;
      }

      .progress-bar {
        width: 100%;
        height: 12px;
        background-color: #ecf0f1;
        border-radius: 6px;
        overflow: hidden;
        margin-bottom: 10px;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(to right, #4b6cb7, #182848);
        width: 0%;
        transition: width 0.3s ease;
      }

      .progress-text {
        display: flex;
        justify-content: space-between;
        font-size: 0.9rem;
        color: #7f8c8d;
      }

      .video-container {
        margin-top: 20px;
        background-color: #2c3e50;
        border-radius: 8px;
        overflow: hidden;
        position: relative;
        min-height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      #outputVideo {
        width: 100%;
        max-height: 400px;
        display: none;
      }

      .placeholder {
        color: white;
        text-align: center;
        padding: 40px 20px;
      }

      .placeholder i {
        font-size: 3rem;
        margin-bottom: 15px;
        color: #4b6cb7;
      }

      .status {
        margin-top: 25px;
        padding: 15px;
        border-radius: 8px;
        display: none;
      }

      .status-success {
        background-color: #d5edda;
        color: #155724;
        border-left: 4px solid #28a745;
      }

      .status-error {
        background-color: #f8d7da;
        color: #721c24;
        border-left: 4px solid #dc3545;
      }

      .status-info {
        background-color: #d1ecf1;
        color: #0c5460;
        border-left: 4px solid #17a2b8;
      }

      .status-processing {
        background-color: #fff3cd;
        color: #856404;
        border-left: 4px solid #ffc107;
      }

      .loader {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #3498db;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-right: 10px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .hidden {
        display: none !important;
      }

      footer {
        text-align: center;
        padding: 20px;
        color: #7f8c8d;
        font-size: 0.9rem;
        border-top: 1px solid #ecf0f1;
      }

      @media (max-width: 768px) {
        .main-content {
          flex-direction: column;
        }

        h1 {
          font-size: 2rem;
        }
      }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  </head>
  <body>
    <div class="container">
      <header>
        <h1>
          <i class="fas fa-video"></i>
          AVI转MP4转换器
        </h1>
        <p class="subtitle">基于FFmpeg.wasm的浏览器端视频格式转换工具</p>
      </header>

      <div class="main-content">
        <div class="left-panel">
          <div class="panel">
            <h2>
              <i class="fas fa-upload"></i>
              上传视频文件
            </h2>

            <div class="file-input-container">
              <label for="fileInput" class="file-label">
                <i class="fas fa-file-video"></i>
                选择AVI文件
              </label>
              <input type="file" id="fileInput" accept=".avi" />

              <div id="fileInfo" class="file-info hidden">
                <p class="file-name" id="fileName"></p>
                <p class="file-size" id="fileSize"></p>
              </div>
            </div>

            <div class="controls">
              <button id="convertBtn" class="btn btn-convert" disabled>
                <i class="fas fa-sync-alt"></i>
                开始转换
              </button>

              <a id="downloadBtn" class="btn btn-download hidden" download>
                <i class="fas fa-download"></i>
                下载MP4文件
              </a>

              <button id="resetBtn" class="btn btn-reset">
                <i class="fas fa-redo"></i>
                重置
              </button>
            </div>

            <div class="progress-container">
              <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
              </div>
              <div class="progress-text">
                <span id="progressText">准备就绪</span>
                <span id="progressPercent">0%</span>
              </div>
            </div>

            <div id="statusMessage" class="status"></div>
          </div>
        </div>

        <div class="right-panel">
          <div class="panel">
            <h2>
              <i class="fas fa-play-circle"></i>
              视频预览
            </h2>

            <div class="video-container">
              <div id="videoPlaceholder" class="placeholder">
                <i class="fas fa-film"></i>
                <p>转换后的视频将在这里显示</p>
              </div>
              <video id="outputVideo" controls></video>
            </div>

            <div class="conversion-info">
              <h3>
                <i class="fas fa-info-circle"></i>
                转换信息
              </h3>
              <div id="conversionDetails">
                <p>等待文件上传和转换...</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <footer>
        <p>使用FFmpeg.wasm技术在浏览器中直接转换视频格式，无需上传到服务器</p>
        <p>注意：大文件转换可能需要较长时间并占用较多内存</p>
      </footer>
    </div>

    <!-- 使用ES6模块方式加载FFmpeg -->
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.4/dist/ffmpeg.min.js"></script>
    <script>
      // 动态导入FFmpeg库
      let ffmpeg = null;
      let selectedFile = null;
      let convertedBlob = null;

      // DOM元素
      const fileInput = document.getElementById('fileInput');
      const fileInfo = document.getElementById('fileInfo');
      const fileName = document.getElementById('fileName');
      const fileSize = document.getElementById('fileSize');
      const convertBtn = document.getElementById('convertBtn');
      const downloadBtn = document.getElementById('downloadBtn');
      const resetBtn = document.getElementById('resetBtn');
      const outputVideo = document.getElementById('outputVideo');
      const videoPlaceholder = document.getElementById('videoPlaceholder');
      const progressFill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');
      const progressPercent = document.getElementById('progressPercent');
      const statusMessage = document.getElementById('statusMessage');
      const conversionDetails = document.getElementById('conversionDetails');

      // 初始化FFmpeg
      async function initFFmpeg() {
        try {
          showStatus('正在加载FFmpeg引擎...', 'info');
          progressText.textContent = '正在加载FFmpeg引擎...';

          // 动态导入FFmpeg库
          const { createFFmpeg } = await import('https://unpkg.com/@ffmpeg/ffmpeg@0.12.4/dist/ffmpeg.min.js');

          ffmpeg = createFFmpeg({
            log: true,
            corePath: 'https://unpkg.com/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js',
          });

          await ffmpeg.load();

          showStatus('FFmpeg加载完成，可以开始转换', 'success');
          progressText.textContent = '准备就绪';
          console.log('FFmpeg加载完成');
        } catch (error) {
          showStatus(`FFmpeg加载失败: ${error.message}`, 'error');
          console.error('FFmpeg加载失败:', error);
        }
      }

      // 获取fetchFile函数
      async function fetchFile(file) {
        return new Uint8Array(await file.arrayBuffer());
      }

      // 显示状态消息
      function showStatus(message, type) {
        statusMessage.textContent = message;
        statusMessage.className = `status status-${type}`;
        statusMessage.style.display = 'block';
      }

      // 隐藏状态消息
      function hideStatus() {
        statusMessage.style.display = 'none';
      }

      // 格式化文件大小
      function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
      }

      // 文件选择处理
      fileInput.addEventListener('change', function (e) {
        if (this.files.length === 0) return;

        selectedFile = this.files[0];

        // 检查文件类型
        if (!selectedFile.name.toLowerCase().endsWith('.avi')) {
          showStatus('请选择AVI格式的视频文件', 'error');
          resetFileSelection();
          return;
        }

        // 显示文件信息
        fileName.textContent = selectedFile.name;
        fileSize.textContent = formatFileSize(selectedFile.size);
        fileInfo.classList.remove('hidden');

        // 启用转换按钮
        convertBtn.disabled = false;

        // 更新转换信息
        conversionDetails.innerHTML = `
                <p><strong>文件名:</strong> ${selectedFile.name}</p>
                <p><strong>文件大小:</strong> ${formatFileSize(selectedFile.size)}</p>
                <p><strong>目标格式:</strong> MP4 (H.264/AAC)</p>
            `;

        showStatus('文件已选择，点击"开始转换"按钮进行转换', 'info');
      });

      // 重置文件选择
      function resetFileSelection() {
        fileInput.value = '';
        fileInfo.classList.add('hidden');
        selectedFile = null;
        convertBtn.disabled = true;
        downloadBtn.classList.add('hidden');
        outputVideo.style.display = 'none';
        videoPlaceholder.classList.remove('hidden');
        outputVideo.src = '';
        convertedBlob = null;
        progressFill.style.width = '0%';
        progressPercent.textContent = '0%';
        progressText.textContent = '准备就绪';
        conversionDetails.innerHTML = '<p>等待文件上传和转换...</p>';
        hideStatus();
      }

      // 转换视频
      async function convertVideo() {
        if (!selectedFile || !ffmpeg) return;

        try {
          // 禁用转换按钮，显示处理中状态
          convertBtn.disabled = true;
          convertBtn.innerHTML = '<span class="loader"></span> 转换中...';
          downloadBtn.classList.add('hidden');
          outputVideo.style.display = 'none';
          videoPlaceholder.classList.remove('hidden');

          // 显示进度
          progressFill.style.width = '5%';
          progressPercent.textContent = '5%';
          progressText.textContent = '正在准备转换...';
          showStatus('开始转换视频，请耐心等待...', 'processing');

          // 生成文件名
          const inputFileName = 'input.avi';
          const outputFileName = 'output.mp4';

          // 设置进度回调
          ffmpeg.setProgress(({ ratio }) => {
            const percent = Math.min(95, Math.floor(ratio * 100));
            progressFill.style.width = `${percent}%`;
            progressPercent.textContent = `${percent}%`;
            progressText.textContent = `正在转换: ${percent}%`;

            if (percent >= 95) {
              progressText.textContent = '正在生成最终文件...';
            }
          });

          // 写入文件到FFmpeg虚拟文件系统
          progressText.textContent = '正在读取文件...';
          ffmpeg.FS('writeFile', inputFileName, await fetchFile(selectedFile));

          // 执行转换命令
          progressText.textContent = '正在转换视频编码...';

          // 使用优化的转换参数
          await ffmpeg.run(
            '-i',
            inputFileName,
            '-c:v',
            'libx264', // 视频编码器
            '-preset',
            'medium', // 编码速度/质量平衡
            '-crf',
            '23', // 质量因子 (0-51, 越小质量越好)
            '-c:a',
            'aac', // 音频编码器
            '-b:a',
            '128k', // 音频比特率
            '-movflags',
            '+faststart', // 优化网络播放
            outputFileName
          );

          // 读取结果
          progressText.textContent = '正在读取转换结果...';
          const data = ffmpeg.FS('readFile', outputFileName);

          // 创建Blob对象
          convertedBlob = new Blob([data.buffer], { type: 'video/mp4' });

          // 生成预览URL
          const videoUrl = URL.createObjectURL(convertedBlob);
          outputVideo.src = videoUrl;

          // 更新UI
          progressFill.style.width = '100%';
          progressPercent.textContent = '100%';
          progressText.textContent = '转换完成!';
          convertBtn.innerHTML = '<i class="fas fa-check"></i> 转换完成';
          showStatus('视频转换成功!', 'success');

          // 显示视频和下载按钮
          outputVideo.style.display = 'block';
          videoPlaceholder.classList.add('hidden');

          // 更新下载按钮
          const outputFileNameDisplay = selectedFile.name.replace(/\.avi$/i, '.mp4');
          downloadBtn.href = videoUrl;
          downloadBtn.download = outputFileNameDisplay;
          downloadBtn.classList.remove('hidden');

          // 更新转换信息
          conversionDetails.innerHTML = `
                    <p><strong>原始文件:</strong> ${selectedFile.name}</p>
                    <p><strong>原始大小:</strong> ${formatFileSize(selectedFile.size)}</p>
                    <p><strong>转换后格式:</strong> MP4 (H.264/AAC)</p>
                    <p><strong>转换后大小:</strong> ${formatFileSize(convertedBlob.size)}</p>
                    <p><strong>状态:</strong> <span style="color:green;">✓ 转换成功</span></p>
                `;

          console.log('视频转换完成，大小:', formatFileSize(convertedBlob.size));
        } catch (error) {
          console.error('转换出错:', error);
          showStatus(`转换失败: ${error.message}`, 'error');
          progressText.textContent = '转换失败';
          convertBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> 转换失败';

          // 重新启用转换按钮
          setTimeout(() => {
            convertBtn.disabled = false;
            convertBtn.innerHTML = '<i class="fas fa-sync-alt"></i> 重新转换';
          }, 2000);
        }
      }

      // 事件监听
      convertBtn.addEventListener('click', convertVideo);
      resetBtn.addEventListener('click', resetFileSelection);

      // 页面加载时初始化
      window.addEventListener('DOMContentLoaded', async () => {
        await initFFmpeg();
      });

      // 清理URL对象
      window.addEventListener('beforeunload', () => {
        if (outputVideo.src.startsWith('blob:')) {
          URL.revokeObjectURL(outputVideo.src);
        }
      });
    </script>
  </body>
</html>
